#!/usr/bin/env php
<?php

use Phpkg\Signals\ConfirmationInquiry;
use Phpkg\Signals\InputPromptMessage;
use PhpRepos\Cli\Output;
use PhpRepos\Console\Input;
use PhpRepos\FileManager\Path;
use PhpRepos\Git\Signals\GitHostDownloadProgress;
use PhpRepos\Git\Signals\SendingGitHttpRequest;
use PhpRepos\Git\Signals\HttpResponseReceived;
use PhpRepos\Logger\Log\Level;
use PhpRepos\Logger\Log\Message;
use PhpRepos\Logger\Logs;
use PhpRepos\Observer\Observer;
use PhpRepos\Observer\Signals\Internals\HandlerExecution;
use PhpRepos\Observer\Signals\Internals\HandlerFound;
use PhpRepos\Observer\Signals\Internals\NoHandlerFound;
use PhpRepos\Observer\Signals\Signal;
use function Phpkg\Cli\Runner\execute;
use function Phpkg\InfrastructureStructure\CLI\progressbar;
use function Phpkg\InfrastructureStructure\CLI\show_spinner;
use function Phpkg\InfrastructureStructure\CLI\hide_spinner;
use function PhpRepos\Console\Runner\from_path;
use function PhpRepos\Logger\Media\file_lock;

putenv('PHPKG_ROOT=' . __DIR__);

global $argv;

$verbose = getopt('v::', [], $index_after_verbosity);
$wants_verbose = isset($verbose['v']) && $index_after_verbosity <= 3;

$help_options = getopt('h', ['help'], $index_after_help);
$wants_help = (isset($help_options['h']) || isset($help_options['help'])) && $index_after_help <= 3;

if ($wants_help && $wants_verbose) {
    $offset = 3;
} else if ($wants_help || $wants_verbose) {
    $offset = 2;
} else {
    $offset = 1;
}

$verbosity_level = $wants_verbose ? strlen($verbose['v']) + 1 : 0;

$cli_logger = function (Message $message) {
    $context = json_encode($message->context);
    $format = <<<EOD
\e[34m[{$message->time->format('Y-m-d\TH:i:s.uP')}] \e[33m{$message->level->name}:\e[39m {$message->text} \e[34m{$context}
EOD;

    Output\line($format);
};

Logs\default_media(function (Message $message) use ($verbosity_level, $cli_logger) {
    file_lock(Path::from(__DIR__)->sub('Logs/phpkg.log'))($message);

    if ($verbosity_level <= 1) {
        return;
    }

    if ($verbosity_level === 2 && in_array($message->level, [Level::DEBUG, Level::NOTICE])) {
        return;
    }

    $cli_logger($message);
});

Observer\subscribe(function (Signal $signal) use ($verbosity_level, $cli_logger) {
    Logs\log(Message::info('A signal has been sent.', $signal->jsonSerialize()), file_lock(Path::from(__DIR__)->sub('Logs/console-signals.log')));

    if ($verbosity_level === 0 || in_array(get_class($signal), [HandlerFound::class, NoHandlerFound::class, HandlerExecution::class])) {
        return;
    }

    $cli_logger(Message::info("Signal $signal->title", $signal->details));
});

Observer\subscribe(function (ConfirmationInquiry $inquiry) {
    Output\line($inquiry->time->format('Y-m-d\TH:i:s.uP') . ': ' . $inquiry->details['prompt'] . ' ');
    return InputPromptMessage::create('Input Prompt Received', ['prompt' => $inquiry->details['prompt'], 'answer' => trim(fgets(STDIN))]);
});

Observer\subscribe(function (GitHostDownloadProgress $progress) use ($verbosity_level) {
    if ($verbosity_level > 0) return;
    $details = $progress->details;
    
    // Generate unique ID for this download (includes full hash)
    $id = sprintf(
        '%s/%s/%s@%s',
        $details['domain'],
        $details['owner'],
        $details['repo'],
        $details['hash']
    );
    
    // Generate GitHub commit URL for clickable link
    $url = null;
    if ($details['domain'] === 'github.com') {
        $url = sprintf(
            'https://github.com/%s/%s/commit/%s',
            $details['owner'],
            $details['repo'],
            $details['hash']
        );
    }
    
    progressbar(
        $id,
        $url,
        $details['downloaded'],
        $details['download_size'],
        $details['time']
    );
});

Observer\subscribe(fn (SendingGitHttpRequest $plan) => show_spinner($plan->title . ' ' . $plan->details['method'] . ': ' . $plan->details['url']));
Observer\subscribe(fn (HttpResponseReceived $event) => hide_spinner());

$inputs = Input::make(array_slice($argv, $offset));
$commands_directory = Path::from(__DIR__)->sub('Commands');
$command_handlers = from_path($commands_directory);

exit(execute($command_handlers, $inputs, $wants_help, $commands_directory, '[-v | -vv | -vvv]'));
