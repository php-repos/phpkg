#!/usr/bin/env php
<?php

require __DIR__ . '/Packages/saeghe/cli/Source/IO/Read.php';
require __DIR__ . '/Packages/saeghe/cli/Source/IO/Write.php';
require __DIR__ . '/Source/Commands/Add.php';
require __DIR__ . '/Source/Commands/Build.php';
require __DIR__ . '/Source/Commands/Help.php';
require __DIR__ . '/Source/Commands/Initialize.php';
require __DIR__ . '/Source/Commands/Install.php';
require __DIR__ . '/Source/Commands/Migrate.php';
require __DIR__ . '/Source/Commands/Remove.php';
require __DIR__ . '/Source/Commands/Update.php';

use Saeghe\Cli\IO\Read;

$setting = [
    'map' => [],
    'entry-points' => [],
    'executables' => [],
    'packages-directory' => 'Packages',
    'packages' => [],
];

$lockSetting = ['packages' => []];

$credentials = json_decode(json: file_get_contents(__DIR__ . '/credentials.json'), associative: true, flags: JSON_THROW_ON_ERROR);

$project = Read\argument('project', '');
$config = Read\argument('config', 'build.json');

$projectRoot = strlen($project) ? $_SERVER['PWD'] . '/' . $project . '/' : $_SERVER['PWD'] . '/';

$configPath = $projectRoot . $config;
$setting = array_merge($setting, file_exists($configPath) ? json_decode(json: file_get_contents($configPath), associative: true, flags: JSON_THROW_ON_ERROR) : []);

$lockPath = str_replace('.json', '-lock.json', $configPath);
$lockSetting = array_merge($lockSetting, file_exists($lockPath) ? json_decode(json: file_get_contents($lockPath), associative: true, flags: JSON_THROW_ON_ERROR) : []);

$packagesDirectory = $projectRoot . $setting['packages-directory'] . '/';

$command = Read\argument('command', 'help');

match ($command) {
    'add' => \Saeghe\Saeghe\Commands\Add\run(),
    'build' => \Saeghe\Saeghe\Commands\Build\run(),
    'initialize' => \Saeghe\Saeghe\Commands\Initialize\run(),
    'install' => \Saeghe\Saeghe\Commands\Install\run(),
    'migrate' => \Saeghe\Saeghe\Commands\Migrate\run(),
    'remove' => \Saeghe\Saeghe\Commands\Remove\run(),
    'update' => \Saeghe\Saeghe\Commands\Update\run(),
    default => \Saeghe\Saeghe\Commands\Help\run(),
};
